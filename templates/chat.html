{% extends 'base.html' %}

{% block title %}
ëŒ€í™”í˜• ë¹„íƒ€ë¯¼ ì±—
{% endblock %}

{% block content %}
<div class="chat-layout">
    <aside class="left-sidebar">
        <h3>ë©”ë‰´</h3>
        <a href="{{ url_for('chat') }}" class="btn-new-chat">
            ìƒˆ ëŒ€í™” ì‹œì‘
        </a>
        <a href="{{ url_for('history') }}" class="btn-history">
            ì „ì²´ ëŒ€í™” ì´ë ¥
        </a>
    </aside>

    <main class="chat-main">
        <h2>ëŒ€í™”í˜• ë¹„íƒ€ë¯¼ ì±—</h2>
        <div class="user-info-inputs">
            <label>ë‚˜ì´:
                <input id="age-input" type="number" min="1" max="120" style="width:80px;" value="{{ user_age or '' }}">
            </label>
            <label>ì„±ë³„:
                <select id="gender-select">
                    <option value="">ì„ íƒ</option>
                    <option value="ë‚¨ì„±" {% if user_gender == 'ë‚¨ì„±' %}selected{% endif %}>ë‚¨ì„±</option>
                    <option value="ì—¬ì„±" {% if user_gender == 'ì—¬ì„±' %}selected{% endif %}>ì—¬ì„±</option>
                    <option value="ê¸°íƒ€" {% if user_gender == 'ê¸°íƒ€' %}selected{% endif %}>ê¸°íƒ€</option>
                </select>
            </label>
        </div>

        <div id="chat-box">
            {% for c in logs %}
            <div class="conversation-item" data-conv-id="{{ c.id }}">
                <div style="text-align:right; margin-bottom: 5px;"><strong>ë‚˜ ({{ c.age }}ì„¸ {{ c.gender }}):</strong> {{ c.user_message }}</div>
                <div style="text-align:left;">
                    <strong>ì±—ë´‡:</strong>
                    <div class="recommendation">{{ c.bot_reply | safe }}</div>
                    <div class="actions">
                        <button class="btn-email">ì´ë©”ì¼ë¡œ ë°›ê¸°</button>
                        <button class="btn-save" {% if c.saved %}disabled{% endif %}>
                            {% if c.saved %}âœ… ì €ì¥ë¨{% else %}ë©”ëª¨í•˜ê¸°{% endif %}
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div class="input-area">
            <input id="user-input" type="text" placeholder="ì¦ìƒ ì…ë ¥">
            <button id="send-btn">ì „ì†¡</button>
        </div>
    </main>

    <aside class="right-sidebar">
        <div class="info-card">
            <h3>ğŸ’¡ ì‚¬ìš© íŒ</h3>
            <ul>
                <li><strong>êµ¬ì²´ì ì¸ ì¦ìƒ</strong>ì„ ì•Œë ¤ì£¼ì„¸ìš”. (ì˜ˆ: "í”¼ê³¤í•˜ê³  ëˆˆì´ ë»‘ë»‘í•´ìš”")</li>
                <li><strong>ì•“ê³  ìˆëŠ” ì§ˆí™˜</strong>ì´ë‚˜ <strong>ë³µìš© ì¤‘ì¸ ì•½</strong>ì´ ìˆë‹¤ë©´ í•¨ê»˜ ì•Œë ¤ì£¼ì„¸ìš”.</li>
                <li>ì¶”ì²œ ë°›ì€ ì œí’ˆì€ ì°¸ê³ ìš©ìœ¼ë¡œ í™œìš©í•˜ì„¸ìš”.</li>
            </ul>
        </div>
        <div class="info-card disclaimer">
            <h3>âš ï¸ ì£¼ì˜ì‚¬í•­</h3>
            <p>
                ë³¸ ì„œë¹„ìŠ¤ê°€ ì œê³µí•˜ëŠ” ì •ë³´ëŠ” ì°¸ê³ ìš©ì´ë©°, ì˜í•™ì ì¸ ì§„ë‹¨ì´ë‚˜ ì²˜ë°©ì„ ëŒ€ì²´í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. 
                <strong>ê±´ê°•ì— ê´€í•œ ë¬¸ì œëŠ” ë°˜ë“œì‹œ ì „ë¬¸ ì˜ì‚¬ì™€ ìƒë‹´í•˜ì„¸ìš”.</strong>
            </p>
        </div>
    </aside>
</div>


<script>
// ... (JavaScript ì½”ë“œëŠ” ì´ì „ê³¼ ë™ì¼) ...
document.getElementById('send-btn').addEventListener('click', async () => {
    const sendBtn = document.getElementById('send-btn');
    const userInput = document.getElementById('user-input');
    const age = parseInt(document.getElementById('age-input').value);
    const gender = document.getElementById('gender-select').value;
    const message = userInput.value.trim();
    const chatBox = document.getElementById('chat-box');

    if (!age || !gender) return alert('ë‚˜ì´ì™€ ì„±ë³„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
    if (!message) return alert('ì¦ìƒì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');

    sendBtn.disabled = true;
    sendBtn.textContent = 'ìƒì„± ì¤‘...';

    const convItem = document.createElement('div');
    convItem.className = 'conversation-item';

    const userDiv = document.createElement('div');
    userDiv.style.textAlign = 'right';
    userDiv.style.marginBottom = '5px';
    userDiv.innerHTML = `<strong>ë‚˜ (${age}ì„¸ ${gender}):</strong> ${message}`;
    convItem.appendChild(userDiv);

    const botOuterDiv = document.createElement('div');
    botOuterDiv.style.textAlign = 'left';
    botOuterDiv.innerHTML = `
        <strong>ì±—ë´‡:</strong>
        <div class="recommendation"></div>
        <div class="actions" style="display: none;">
            <button class="btn-email">ì´ë©”ì¼ë¡œ ë°›ê¸°</button>
            <button class="btn-save">ë©”ëª¨í•˜ê¸°</button>
        </div>
    `;
    convItem.appendChild(botOuterDiv);
    chatBox.appendChild(convItem);
    chatBox.scrollTop = chatBox.scrollHeight;
    userInput.value = '';

    const recommendationDiv = botOuterDiv.querySelector('.recommendation');
    const actionsDiv = botOuterDiv.querySelector('.actions');

    try {
        const response = await fetch('/chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({message, age, gender})
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${errorText}`);
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();

        while (true) {
            const { value, done } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value, { stream: true });
            
            if (chunk.includes('__CONV_ID__')) {
                const parts = chunk.split('__CONV_ID__');
                recommendationDiv.innerText += parts[0];
                const convId = parts[1].trim();
                if(convId) {
                    convItem.dataset.convId = convId;
                    actionsDiv.style.display = 'block';
                }
            } else {
                recommendationDiv.innerText += chunk;
            }
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    } catch (error) {
        recommendationDiv.innerText = `ì˜¤ë¥˜ ë°œìƒ: ${error.message}`;
        recommendationDiv.style.color = 'red';
    } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = 'ì „ì†¡';
    }
});

document.getElementById('chat-box').addEventListener('click', async (e) => {
    const target = e.target;
    const convItem = target.closest('.conversation-item');
    if (!convItem) return;

    const convId = convItem.dataset.convId;
    if (!convId) return;

    if (target.classList.contains('btn-email')) {
        target.disabled = true;
        target.textContent = 'ì „ì†¡ ì¤‘...';
        try {
            const res = await fetch('/send_email', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ conv_id: convId })
            });
            const result = await res.json();
            if (!result.success) throw new Error(result.error);
            alert('ì´ë©”ì¼ ì „ì†¡ ì™„ë£Œ!');
        } catch (error) {
            alert(`ì˜¤ë¥˜: ${error.message}`);
        } finally {
            target.disabled = false;
            target.textContent = 'ì´ë©”ì¼ë¡œ ë°›ê¸°';
        }
    }

    if (target.classList.contains('btn-save')) {
        target.disabled = true;
        target.textContent = 'ì €ì¥ ì¤‘...';
        try {
            const res = await fetch('/save_note', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ conv_id: convId })
            });
            const result = await res.json();
            if (!result.success) throw new Error(result.error);
            target.textContent = 'âœ… ì €ì¥ë¨';
        } catch (error) {
            alert(`ì˜¤ë¥˜: ${error.message}`);
            target.textContent = 'ë©”ëª¨í•˜ê¸°';
            target.disabled = false;
        }
    }
});
</script>
{% endblock %}